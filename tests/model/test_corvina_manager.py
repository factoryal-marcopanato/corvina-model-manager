import functools
import unittest

import orjson

from model.corvina_manager import CorvinaManager
from model.datamodel.datamodel_root import DataModelRoot
from model.mapping.mapping_root import MappingRoot
from utils.tree_visit_utils import dfs


class CorvinaManagerTestCase(unittest.TestCase):

    def test_mapping_upgrade_fun(self):
        upgraded_model = DataModelRoot.from_dict(orjson.loads('{"id":null,"name":"PanaTest-Minikube","data":{"type":"object","instanceOf":"PanaTest-Minikube:1.0.0","properties":{"S":{"type":"object","instanceOf":"PanaTest-Minikube.S:9.9.9","properties":{"A1":{"type":"object","instanceOf":"PanaTest-Minikube.S.A1:9.9.9","properties":{"PLine2":{"type":"object","instanceOf":"PanaTest-Minikube.S.A1.PLine2:9.9.9","properties":{"WCell4":{"type":"object","instanceOf":"PanaTest-Minikube.S.A1.PLine2.WCell4:9.9.9","properties":{"DriverMachine":{"type":"object","instanceOf":"PanaTest-Minikube.S.A1.PLine2.WCell4.DriverMachine:9.9.9","properties":{"IntegerValue":{"version":"1.0.0","type":"integer"},"IntegratedSin":{"version":"1.0.0","type":"double"}}}}}}}}},"A2":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2:9.9.9","properties":{"PLine2":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2:9.9.9","properties":{"WCell3":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2.WCell3:9.9.9","properties":{"Modbus":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2.WCell3.Modbus:9.9.9","properties":{"IntegerValue":{"version":"1.0.0","type":"integer"},"IntegratedSin":{"version":"1.0.0","type":"double"}}}}},"WCell4":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2.WCell4:9.9.9","properties":{"DriverMachine":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2.WCell4.DriverMachine:9.9.9","properties":{"IntegerValue":{"version":"1.0.0","type":"integer"},"IntegratedSin":{"version":"1.0.0","type":"double"}}}}}}}}}}},"S2":{"type":"object","instanceOf":"PanaTest-Minikube.S2:9.9.9","properties":{"A1":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A1:9.9.9","properties":{"PLine2":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A1.PLine2:9.9.9","properties":{"WCell4":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A1.PLine2.WCell4:9.9.9","properties":{"DriverMachine":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A1.PLine2.WCell4.DriverMachine:9.9.9","properties":{"IntegerValue":{"version":"1.0.0","type":"integer"},"IntegratedSin":{"version":"1.0.0","type":"double"}}}}}}}}},"A2":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A2:9.9.9","properties":{"PLine2":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A2.PLine2:9.9.9","properties":{"WCell4":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A2.PLine2.WCell4:9.9.9","properties":{"DriverMachine":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A2.PLine2.WCell4.DriverMachine:9.9.9","properties":{"IntegerValue":{"version":"1.0.0","type":"integer"},"IntegratedSin":{"version":"1.0.0","type":"double"}}}}}}}}}}}},"label":"","unit":"","description":"","UUID":null,"tags":[]},"deleted":false,"version":"1.0.0"}'))
        mapping = MappingRoot.from_dict(orjson.loads('{"id":null,"name":"PanaTest-Minikube_Mapping","data":{"type":"object","instanceOf":"PanaTest-Minikube:1.0.0","properties":{"S":{"type":"object","instanceOf":"PanaTest-Minikube.S:1.0.0","properties":{"A1":{"type":"object","instanceOf":"PanaTest-Minikube.S.A1:1.0.0","properties":{"PLine2":{"type":"object","instanceOf":"PanaTest-Minikube.S.A1.PLine2:1.0.0","properties":{"WCell4":{"type":"object","instanceOf":"PanaTest-Minikube.S.A1.PLine2.WCell4:1.0.0","properties":{"DriverMachine":{"type":"object","instanceOf":"PanaTest-Minikube.S.A1.PLine2.WCell4.DriverMachine:1.0.0","properties":{"IntegerValue":{"version":"1.0.0","type":"integer","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S.A1.PLine2.WCell4.DriverMachine.IntegerValue"}},"IntegratedSin":{"version":"1.0.0","type":"double","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S.A1.PLine2.WCell4.DriverMachine.IntegratedSin"}}}}}}}}}},"A2":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2:1.0.0","properties":{"PLine2":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2:1.0.0","properties":{"WCell3":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2.WCell3:1.0.0","properties":{"Modbus":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2.WCell3.Modbus:1.0.0","properties":{"IntegerValue":{"version":"1.0.0","type":"integer","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S.A2.PLine2.WCell3.Modbus.IntegerValue"}},"IntegratedSin":{"version":"1.0.0","type":"double","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S.A2.PLine2.WCell3.Modbus.IntegratedSin"}}}}}},"WCell4":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2.WCell4:1.0.0","properties":{"DriverMachine":{"type":"object","instanceOf":"PanaTest-Minikube.S.A2.PLine2.WCell4.DriverMachine:1.0.0","properties":{"IntegerValue":{"version":"1.0.0","type":"integer","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S.A2.PLine2.WCell4.DriverMachine.IntegerValue"}},"IntegratedSin":{"version":"1.0.0","type":"double","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S.A2.PLine2.WCell4.DriverMachine.IntegratedSin"}}}}}}}}}}}},"S2":{"type":"object","instanceOf":"PanaTest-Minikube.S2:1.0.0","properties":{"A1":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A1:1.0.0","properties":{"PLine2":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A1.PLine2:1.0.0","properties":{"WCell4":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A1.PLine2.WCell4:1.0.0","properties":{"DriverMachine":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A1.PLine2.WCell4.DriverMachine:1.0.0","properties":{"IntegerValue":{"version":"1.0.0","type":"integer","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S2.A1.PLine2.WCell4.DriverMachine.IntegerValue"}},"IntegratedSin":{"version":"1.0.0","type":"double","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S2.A1.PLine2.WCell4.DriverMachine.IntegratedSin"}}}}}}}}}},"A2":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A2:1.0.0","properties":{"PLine2":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A2.PLine2:1.0.0","properties":{"WCell4":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A2.PLine2.WCell4:1.0.0","properties":{"DriverMachine":{"type":"object","instanceOf":"PanaTest-Minikube.S2.A2.PLine2.WCell4.DriverMachine:1.0.0","properties":{"IntegerValue":{"version":"1.0.0","type":"integer","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S2.A2.PLine2.WCell4.DriverMachine.IntegerValue"}},"IntegratedSin":{"version":"1.0.0","type":"double","mode":"R","historyPolicy":{"enabled":true},"sendPolicy":{"triggers":[{"changeMask":"value","minIntervalMs":1000,"skipFirstNChanges":0,"type":"onchange"}]},"datalink":{"source":"Minikube.S2.A2.PLine2.WCell4.DriverMachine.IntegratedSin"}}}}}}}}}}}}},"label":"","unit":"","description":"","UUID":null,"tags":[]},"deleted":null,"modelId":null}'))

        dfs(upgraded_model.data, functools.partial(CorvinaManager._mapping_update_fun, mapping.data))

        print(mapping)

        self.assertTrue(True)